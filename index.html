<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Tarjetas de Memoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #1f2937;
        }
        .container {
            max-width: 600px;
            width: 100%;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
        }
        .card {
            background-color: #e5e7eb;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            transform-style: preserve-3d;
        }
        .card-inner {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <div class="text-xl ml-4">Cargando... Por favor, espere.</div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container text-center">
            <h1 class="text-3xl font-bold mb-6">Tarjetas de Memoria</h1>

            <div id="card" class="card mb-6">
                <div class="card-inner">
                    <div id="card-front" class="card-front text-lg font-semibold">
                        <span id="front-text">Cargando...</span>
                    </div>
                    <div id="card-back" class="card-back text-lg font-semibold bg-gray-200">
                        <span id="back-text"></span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="next-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors duration-300">
                    Siguiente Tarjeta
                </button>
                <button id="add-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors duration-300">
                    Añadir Tarjeta
                </button>
            </div>
            
            <div id="error-message" class="mt-4 text-red-500 font-bold hidden"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, getDocs, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro para depuración.
        setLogLevel('debug');

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const errorMessageDiv = document.getElementById('error-message');

        function showErrorMessage(message) {
            errorMessageDiv.textContent = `Error: ${message}`;
            errorMessageDiv.classList.remove('hidden');
            loadingOverlay.classList.add('hidden');
            appContainer.classList.add('hidden');
        }

        // --- Configuración de Firebase ---
        let app, auth, db, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;

        try {
            // Verificar si la variable de configuración existe y es una cadena válida
            if (typeof __firebase_config === 'string' && __firebase_config.trim() !== '') {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log('Configuración de Firebase detectada y parseada.');
            } else {
                const message = 'ERROR: La variable de configuración de Firebase no está definida o es inválida.';
                console.error(message);
                showErrorMessage(message);
            }
        } catch (e) {
            const message = 'ERROR: Falló al parsear la configuración de Firebase: ' + e.message;
            console.error(message);
            showErrorMessage(message);
        }

        // Inicializar Firebase solo si la configuración es válida
        if (firebaseConfig && firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('Firebase App y Firestore inicializados correctamente.');
            } catch (e) {
                const message = 'ERROR: Falló la inicialización de Firebase: ' + e.message;
                console.error(message);
                showErrorMessage(message);
            }
        } else if (firebaseConfig && !firebaseConfig.projectId) {
            const message = 'ERROR: La configuración de Firebase no contiene un "projectId".';
            console.error(message);
            showErrorMessage(message);
        }

        const cards = [
            { front: "Hola", back: "Hello" },
            { front: "Adiós", back: "Goodbye" },
            { front: "Por favor", back: "Please" },
            { front: "Gracias", back: "Thank you" }
        ];

        let currentCardIndex = 0;
        const cardElement = document.getElementById('card');
        const frontText = document.getElementById('front-text');
        const backText = document.getElementById('back-text');
        const nextButton = document.getElementById('next-button');

        function displayCard(card) {
            frontText.textContent = card.front;
            backText.textContent = card.back;
            cardElement.classList.remove('flipped');
        }

        function showNextCard() {
            currentCardIndex = (currentCardIndex + 1) % cards.length;
            displayCard(cards[currentCardIndex]);
        }

        // Event Listeners
        if (cardElement) {
            cardElement.addEventListener('click', () => {
                cardElement.classList.toggle('flipped');
            });
        }

        if (nextButton) {
            nextButton.addEventListener('click', showNextCard);
        }
        
        // --- Manejo de autenticación ---
        // Espera a que Firebase se inicialice correctamente antes de ejecutar la lógica de autenticación
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log('Usuario autenticado:', userId);
                    loadingOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    displayCard(cards[currentCardIndex]);
                } else {
                    console.log('No hay usuario autenticado. Intentando iniciar sesión...');
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                            console.log('Inicio de sesión con token personalizado exitoso.');
                        } else {
                            await signInAnonymously(auth);
                            console.log('Inicio de sesión anónimo exitoso.');
                        }
                    } catch (e) {
                        console.error('ERROR: Falló el inicio de sesión:', e);
                        showErrorMessage(`No se pudo iniciar sesión. ${e.message}`);
                    }
                }
            });
        }
    </script>
</body>
</html>
